name: Release
on:
  push:
    branches:
    - 'main'
    tags:
      - 'v*'
      - 'snapshot'
    paths-ignore:
      - 'docs/**'
      - 'wiki/**'
      - '.github/workflows/publish-wiki.yaml'

env:
  BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
  P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
  KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
  APPLE_ID: ${{ secrets.APPLE_ID }}
  TEAM_ID: ${{ secrets.TEAM_ID }}
  APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  HOMEBREW_NO_AUTO_UPDATE: 1
  RUN_PYTEST: false
  #PATH: "/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:${{ github.workspace }}/.bin"
  CAKE_HOME: "${{ github.workspace }}/.cake"
jobs:
  build:
    if: ${{ github.event_name != 'pull_request' && github.event_name != 'pull_request_target' }}
    runs-on: self-hosted
    timeout-minutes: 60
    steps:
      - name: Check tools
        id: check
        run: |
          echo "run_pytest=${RUN_PYTEST}" >> $GITHUB_OUTPUT
          if [ $RUNNER_ENVIRONMENT == "github-hosted" ]; then
            echo "Running on github-hosted runner, checking for required tools..."
            echo PATH=$PATH
            if [ -z "$(command -v python)" ]; then
              echo "install_python=true" >> $GITHUB_OUTPUT
            else
              echo "install_python=false" >> $GITHUB_OUTPUT
            fi

            if [ -z "$(command -v go)" ]; then
              echo "install_golang=true" >> $GITHUB_OUTPUT
            else
              echo "install_golang=false" >> $GITHUB_OUTPUT
            fi

            if [ -z "$(command -v brew)" ]; then
              echo "install_brew=true" >> $GITHUB_OUTPUT
            else
              echo "install_brew=false" >> $GITHUB_OUTPUT
            fi

            if [ -z "$(command -v swift)" ]; then
              echo "install_swift=true" >> $GITHUB_OUTPUT
            else
              echo "install_swift=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Not running on github-hosted runner, skipping tool checks."
            echo "install_python=false" >> $GITHUB_OUTPUT
            echo "install_golang=false" >> $GITHUB_OUTPUT
            echo "install_brew=false" >> $GITHUB_OUTPUT
            echo "install_swift=false" >> $GITHUB_OUTPUT
          fi

      - name: checkout
        uses: actions/checkout@v4.2.2
        with:
          submodules: recursive
 
      - name: Set up Homebrew
        if: steps.check.outputs.install_brew == 'true'
        uses: Homebrew/actions/setup-homebrew@master

      - name: Setup Python
        uses: actions/setup-python@v5
        if: steps.check.outputs.install_python == 'true'
        with:
          python-version: '3.13' 

      - name: Setup Go
        if: steps.check.outputs.install_golang == 'true'
        uses: actions/setup-go@v5.4.0
        with:
          go-version: '>=1.23.0'
          cache: true
          cache-dependency-path: qcow2convert/go.mod

      - name: Setup Swift
        if: steps.check.outputs.install_swift == 'true'
        uses: swift-actions/setup-swift@v2.3.0

      - name: Version
        id: version
        run: |
          VERSION_TAG="${GITHUB_REF##*/}"
          PACKAGE=false

          if [ -z "$(command -v envsubst)"]; then
            brew install envsubst
          fi

          if [[ "${VERSION_TAG}" == "snapshot" ]]; then
            VERSION_TAG=SNAPSHOT-$(git rev-parse --short HEAD)
            PACKAGE=true
          elif [[ "${VERSION_TAG}" == v* ]]; then
            VERSION_TAG="${VERSION_TAG:1}"
            PACKAGE=true
          fi

          if [ ${PACKAGE} == "true" ] && [ ${GITHUB_EVENT_NAME} != "push" ]; then
            PACKAGE=false
          fi

          echo "VERSION_TAG=${VERSION_TAG}" >> $GITHUB_ENV
          echo "PACKAGE=${PACKAGE}" >> $GITHUB_ENV
          echo "build_package=${PACKAGE}" >> $GITHUB_OUTPUT
          echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT

          TMPFILE=$(mktemp)
          envsubst < Sources/caked/CI/CI.swift > $TMPFILE
          cp $TMPFILE Sources/caked/CI/CI.swift
          cp $TMPFILE Sources/cakectl/CI/CI.swift

      - name: Build QCow2convert framework
        run: |
          cd qcow2convert
          ./build.sh

      - name: Build Swift package
        run: |
          ./Scripts/build-signed-release.sh
 
      - name: Run tests
        run: |
          # Run tests for the Swift package
          export PATH=${GITHUB_WORKSPACE}/dist/Caker.app/Contents/PlugIns:$PATH
          swift test|grep -v Compiling|grep -v CoreData

      - name: Run integration tests
        if: steps.check.outputs.run_pytest == 'true'
        run: |
          # Run tests for the Swift package
          export PATH=${GITHUB_WORKSPACE}/dist/Caker.app/Contents/PlugIns:$PATH
          if [ -z "$(command -v virtualenv)" ]; then
            brew install virtualenv
          fi
          cd integration/tests
          virtualenv venv
          source venv/bin/activate
          pip install -r requirements.txt
          pytest --verbose --junit-xml=pytest-junit.xml

      - name: Install the Apple certificate and provisioning profile
        if: steps.version.outputs.build_package == 'true'
        run: |
          ./.ci/setup-keychain.sh ${RUNNER_TEMP}/app-signing.keychain-db
  
      - name: package
        if: steps.version.outputs.build_package == 'true'
        run: |
          export VERSION_TAG="${GITHUB_REF##*/}"
          ./.ci/create-pkg.sh ${RUNNER_TEMP}/app-signing.keychain-db

      - name: "Create release"
        env:
          VERSION_TAG: ${{ steps.version.outputs.version_tag }}
        if: steps.version.outputs.build_package == 'true'
        run: |
          if [ ${GITHUB_REF##*/} == "snapshot" ]; then
            gh release create --prerelease --generate-notes --title "${VERSION_TAG}" "${VERSION_TAG}" ./.ci/Caker-${VERSION_TAG}.pkg
          else
            gh release create --generate-notes --title "${VERSION_TAG}" "${VERSION_TAG}" ./.ci/Caker-${VERSION_TAG}.pkg
          fi

      - name: "Update release notes from git log"
        env:
          RELEASE_PATHS: Sources wiki .github/workflows
          MAX_COMMITS: "20"
        if: steps.version.outputs.build_package == 'true'
        run: |
          ./Scripts/update-wiki-release-notes-from-git.sh "${GITHUB_REF_NAME}"

      - name: Publish wiki
        env:
          GH_TOKEN: ${{ secrets.WIKI_TOKEN }}
          GITHUB_TOKEN: ${{ github.token }}
        if: steps.version.outputs.build_package == 'true'
        run: |
          chmod +x ./Scripts/publish-wiki.sh
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY##*/}"
          ./Scripts/publish-wiki.sh "${OWNER}" "${REPO}"

      - name: Clean up keychain and provisioning profile
        if: steps.version.outputs.build_package == 'true'
        run: |
          security delete-keychain ${RUNNER_TEMP}/app-signing.keychain-db
